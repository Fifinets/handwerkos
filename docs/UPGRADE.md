# Upgrade Guide: Dual Time Tracking

## Voraussetzungen

- Zugriff auf Supabase Database
- Admin-Rechte für Feature-Flag Aktivierung
- Backup der Datenbank (empfohlen)

---

## Schritt 1: Migrationen ausführen

Alle SQL-Dateien in `/supabase/migrations/` in dieser Reihenfolge ausführen:

```bash
# 1. Feature Flags
psql < supabase/migrations/20251015_01_feature_flags.sql

# 2. Attendance
psql < supabase/migrations/20251015_02_attendance.sql

# 3. Cost Centers
psql < supabase/migrations/20251015_03_cost_centers.sql

# 4. Extend time_entries
psql < supabase/migrations/20251015_04_extend_time_entries.sql

# 5. Timesheet Locks
psql < supabase/migrations/20251015_05_timesheet_locks.sql

# 6. Audit Log
psql < supabase/migrations/20251015_06_audit_log.sql

# 7. Extend time_rules
psql < supabase/migrations/20251015_07_extend_time_rules.sql

# 8. Schema Version
psql < supabase/migrations/20251015_08_schema_version.sql

# 9. Backfill Script (nur Funktion, noch nicht ausführen!)
psql < supabase/migrations/20251015_09_backfill_attendance.sql
```

**Oder über Supabase CLI:**

```bash
supabase db push
```

---

## Schritt 2: Migrationen verifizieren

```sql
-- Prüfe Schema-Version
SELECT get_current_schema_version();
-- Erwartet: '1.0.0-dual-time-tracking'

-- Prüfe Feature-Flag
SELECT * FROM feature_flags WHERE flag_name = 'ff_dual_time_tracking';
-- Erwartet: 1 Zeile, enabled=false

-- Prüfe neue Tabellen
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('attendance', 'cost_centers', 'timesheet_locks', 'time_audit_log');
-- Erwartet: 4 Zeilen

-- Prüfe neue Spalten in time_entries
SELECT column_name FROM information_schema.columns
WHERE table_name = 'time_entries'
AND column_name IN ('type', 'cost_center_id', 'billable', 'gps_location', 'status_approval');
-- Erwartet: 5 Zeilen

-- Prüfe Kostenstellen
SELECT code, name FROM cost_centers ORDER BY sort_order;
-- Erwartet: FAHRT, WERKSTATT, SCHULUNG, URLAUB, KRANK (pro Company)
```

---

## Schritt 3: Alte Daten migrieren (Optional)

⚠️ **Wichtig:** Erst Dry-Run, dann echte Migration!

### 3.1 Dry-Run (Preview)

```sql
SELECT * FROM backfill_attendance_from_time_entries(
  p_start_date := '2025-01-01',
  p_end_date := CURRENT_DATE,
  p_employee_id := NULL, -- Alle Mitarbeiter
  p_dry_run := true      -- NUR Preview!
);
```

Prüfe die Ausgabe:
- Wie viele Records würden erstellt?
- Gibt es Fehler?
- Sind die Zeiten plausibel?

### 3.2 Echte Migration

```sql
-- Für spezifischen Zeitraum
SELECT * FROM backfill_attendance_from_time_entries(
  p_start_date := '2025-01-01',
  p_end_date := '2025-10-15',
  p_employee_id := NULL,
  p_dry_run := false     -- ECHTE Migration!
);

-- Ergebnis prüfen
SELECT COUNT(*) FROM attendance WHERE autogenerated = true;
```

### 3.3 Summen-Prüfung

```sql
-- Vorher: Projektzeiten aus time_entries
SELECT
  employee_id,
  DATE(start_time) AS date,
  SUM(EXTRACT(EPOCH FROM (end_time - start_time)) / 60) AS total_minutes
FROM time_entries
WHERE start_time >= '2025-01-01'
AND end_time IS NOT NULL
GROUP BY employee_id, DATE(start_time)
ORDER BY date DESC, employee_id
LIMIT 10;

-- Nachher: Attendance
SELECT
  employee_id,
  date,
  work_minutes
FROM attendance
WHERE date >= '2025-01-01'
AND autogenerated = true
ORDER BY date DESC, employee_id
LIMIT 10;

-- Sollten ungefähr gleich sein (±Pausenzeit)
```

---

## Schritt 4: Feature-Flag aktivieren

### 4.1 Test-Aktivierung (ein Unternehmen)

```sql
-- Für spezifisches Unternehmen
UPDATE feature_flags
SET enabled = true
WHERE flag_name = 'ff_dual_time_tracking'
AND company_id = '<your_company_id>';
```

### 4.2 Globale Aktivierung (alle Unternehmen)

```sql
-- Für alle Unternehmen
UPDATE feature_flags
SET enabled = true
WHERE flag_name = 'ff_dual_time_tracking'
AND company_id IS NULL;
```

### 4.3 Verifizieren

```sql
-- Prüfe ob aktiviert
SELECT is_feature_enabled('ff_dual_time_tracking', '<company_id>');
-- Erwartet: true
```

---

## Schritt 5: Frontend deployen

```bash
# Build neue Version
npm run build

# Deploy
# (je nach Hosting-Provider)
```

---

## Schritt 6: User-Schulung

1. **Zeige neue UI-Elemente:**
   - "Schicht starten" Button
   - Kostenstellen Quick-Pick
   - Deckungsgrad-Anzeige

2. **Erkläre neuen Flow:**
   - Erst Clock-In, dann Projekt buchen
   - Pausen erfassen
   - Coverage prüfen vor Wochenabgabe

3. **Best Practices:**
   - Lücken vermeiden durch Kostenstellen
   - GPS-Standort zulassen (optional)
   - Tagesabschluss prüfen

---

## Rollback (Falls nötig)

### Feature-Flag deaktivieren

```sql
UPDATE feature_flags
SET enabled = false
WHERE flag_name = 'ff_dual_time_tracking';
```

→ System fällt automatisch zurück auf altes Verhalten!

### Datenbank-Rollback

```sql
-- 1. Schema-Version entfernen
DELETE FROM app_schema_version WHERE version = '1.0.0-dual-time-tracking';

-- 2. Neue Tabellen löschen (VORSICHT!)
DROP TABLE IF EXISTS time_audit_log CASCADE;
DROP TABLE IF EXISTS timesheet_locks CASCADE;
DROP TABLE IF EXISTS attendance CASCADE;
DROP TABLE IF EXISTS cost_centers CASCADE;
DROP TABLE IF EXISTS feature_flags CASCADE;

-- 3. Neue Spalten entfernen (VORSICHT!)
ALTER TABLE time_entries
  DROP COLUMN IF EXISTS type,
  DROP COLUMN IF EXISTS cost_center_id,
  DROP COLUMN IF EXISTS billable,
  DROP COLUMN IF EXISTS gps_location,
  DROP COLUMN IF EXISTS status_approval,
  DROP COLUMN IF EXISTS attendance_id;

ALTER TABLE time_rules
  DROP COLUMN IF EXISTS reconciliation_tolerance_percent,
  DROP COLUMN IF EXISTS require_reconciliation,
  DROP COLUMN IF EXISTS min_breaks_minutes,
  DROP COLUMN IF EXISTS overtime_daily_minutes,
  DROP COLUMN IF EXISTS overtime_weekly_minutes,
  DROP COLUMN IF EXISTS max_work_day_minutes,
  DROP COLUMN IF EXISTS max_work_week_minutes,
  DROP COLUMN IF EXISTS auto_submit_on_coverage,
  DROP COLUMN IF EXISTS coverage_green_min,
  DROP COLUMN IF EXISTS coverage_yellow_min;

-- 4. Funktionen löschen
DROP FUNCTION IF EXISTS backfill_attendance_from_time_entries;
DROP FUNCTION IF EXISTS check_reconciliation;
DROP FUNCTION IF EXISTS detect_attendance_gaps;
DROP FUNCTION IF EXISTS is_week_locked;
DROP FUNCTION IF EXISTS is_feature_enabled;
-- ... etc.
```

⚠️ **Achtung:** Rollback löscht alle Attendance-Daten!

---

## Häufige Probleme

### Problem: Migration schlägt fehl

```
ERROR: relation "companies" does not exist
```

**Lösung:** Companies-Tabelle fehlt. Prüfe Schema.

### Problem: Kostenstellen werden nicht erstellt

```sql
-- Manuell erstellen
INSERT INTO cost_centers (company_id, code, name, billable, payroll, color, icon, sort_order)
VALUES
  ('<company_id>', 'FAHRT', 'Fahrtzeit', true, true, '#3b82f6', 'Car', 10),
  ('<company_id>', 'WERKSTATT', 'Werkstatt', false, true, '#6b7280', 'Wrench', 20);
```

### Problem: Feature-Flag wird nicht erkannt

```sql
-- Cache leeren
SELECT pg_advisory_unlock_all();

-- Flag neu laden
SELECT is_feature_enabled('ff_dual_time_tracking', NULL);
```

### Problem: UI zeigt alte Ansicht

- **Browser-Cache leeren**
- **Hard Refresh** (Ctrl+Shift+R)
- **SessionStorage leeren:**

```javascript
sessionStorage.clear()
location.reload()
```

---

## Performance-Optimierung

Nach Migration großer Datenmengen:

```sql
-- Indizes neu aufbauen
REINDEX TABLE attendance;
REINDEX TABLE time_entries;
REINDEX TABLE time_audit_log;

-- Statistiken aktualisieren
ANALYZE attendance;
ANALYZE time_entries;
ANALYZE cost_centers;

-- Vacuum
VACUUM ANALYZE;
```

---

## Monitoring

### Nach Go-Live überwachen:

```sql
-- Anzahl aktiver Attendance
SELECT COUNT(*) FROM attendance WHERE status = 'open';

-- Coverage-Status heute
SELECT
  e.first_name,
  e.last_name,
  cr.*
FROM employees e
CROSS JOIN LATERAL check_reconciliation(e.id, CURRENT_DATE) cr
WHERE cr.status = 'red'
ORDER BY cr.coverage_percent;

-- Audit-Log der letzten Stunde
SELECT * FROM time_audit_log
WHERE changed_at >= NOW() - INTERVAL '1 hour'
ORDER BY changed_at DESC;
```

---

## Support-Checkliste

- [ ] Alle Migrationen ausgeführt
- [ ] Schema-Version korrekt
- [ ] Kostenstellen vorhanden
- [ ] Backfill erfolgreich (Dry-Run + Echt)
- [ ] Summen-Prüfung erfolgreich
- [ ] Feature-Flag aktiviert
- [ ] UI zeigt neue Komponenten
- [ ] User geschult
- [ ] Monitoring aktiv

---

## Kontakt

Bei Problemen:
- GitHub Issues
- Slack: #handwerkos-support
- Docs: `README_zeiterfassung.md`
